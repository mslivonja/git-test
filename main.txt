Main implementation.

Fix for some bug.