Main implementation.

Fix for some bug.

Fix for some other bug.